dist: trusty
language: rust
rust:
  - 1.19.0
  - nightly
matrix:
  allow_failures:
  - rust: nightly
os:
  - linux
  - osx
notifications:
  webhooks: http://build.servo.org:54856/travis
addons:
  apt:
    sources:
      - sourceline: 'deb http://apt.llvm.org/trusty/ llvm-toolchain-trusty-3.8 main'
        keyurl: 'http://apt.llvm.org/llvm-snapshot.gpg.key'
    packages:
      - libgl1-mesa-dev
      - llvm-3.8-dev
      - libedit-dev
      - libcurl4-openssl-dev
      - libelf-dev
      - libdw-dev
      - libiberty-dev
      - cmake
      - gcc
      - binutils-dev
env:
  - BUILD_KIND=DEBUG RUST_BACKTRACE=1 RUSTFLAGS='--deny warnings'
  - BUILD_KIND=RELEASE RUST_BACKTRACE=1 RUSTFLAGS='--deny warnings'
before_install:
  - pip install mako servo-tidy
script:
  - servo-tidy
  - if [ $BUILD_KIND = DEBUG ]; then (cd webrender_api && cargo test --verbose --features "ipc"); fi
  - if [ $BUILD_KIND = DEBUG ]; then (cd webrender && cargo build --verbose --no-default-features); fi
  - if [ $BUILD_KIND = DEBUG ]; then (cargo test --all --verbose); fi
  - if [ $BUILD_KIND = RELEASE ]; then (cargo test --all --verbose); fi
  - if [ $BUILD_KIND = DEBUG ]; then (wget https://github.com/SimonKagstrom/kcov/archive/master.tar.gz &&
                                        sudo make install); fi  
  - if [ $BUILD_KIND = DEBUG ]; then (cd wrench && mkdir cov && python headless.py --subpixel-aa reftest); fi
  - if [ $BUILD_KIND = RELEASE ]; then (cd wrench && cargo build --release --features=debugger); fi
  - if [ $TRAVIS_RUST_VERSION == "nightly" ]; then (cd webrender && cargo bench --verbose); fi
